<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> my favorites! </title>
    <link rel="stylesheet" href="favorite.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>
</head>
<body>
    <h1> my favorites! </h1>
    <p> <b> here is a collection of my favorite places in pune </b> </p>
    <div class="app">
        <div class="control-panel">
        <div class="filter-section">
        <h3> filter places by category </h3>
        <div class="category-buttons" id="categoryButtons"></div>
        </div>
      <button class="add-place-btn" id="toggleFormBtn">+ Add Place</button>
      <div class="map-instruction hidden" id="mapInstruction"> click on the map to add a place 
      </div>

      <form class="add-place-form hidden" id="addPlaceForm">
        <input type="text" id="placeName" placeholder="place name" required>
        <select id="placeCategory"></select>
        <input type="number" step="0.0001" id="placeLat" placeholder="Latitude (click map)" required readonly>
        <input type="number" step="0.0001" id="placeLng" placeholder="Longitude (click map)" required readonly>
        <textarea id="placeDescription" placeholder="description"></textarea>
        <input type="number" min="1" max="5" id="placeRating" placeholder="rating (1-5)" required>
        <button type="submit" class="submit-btn">add place</button>
      </form>
      <div class="places-list">
        <h3> places (<span id="placeCount">0</span>)</h3>
        <div class="places-scroll" id="placesList"></div>
      </div>
    </div>
    <div id="map"></div>
  </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const API_URL = 'http://localhost:5001';
    const categories = ['all', 'cafe', 'park', 'restaurant', 'museum', 'temple', 'other'];
    let places = [];
    let filteredPlaces = [];
    let selectedCategory = 'all';
    let map;
    let markers = [];
    let tempMarker = null;
    let isAddingPlace = false;
    let socket;
    const PUNE_CENTER = [18.5204, 73.8567];
    const categoryColors = {
            cafe: '#f59e0b',
            park: '#10b981',
            restaurant: '#ef4444',
            museum: '#a855f7',
            temple: '#3b82f6',
            other: '#6b7280' }
    function createCustomIcon(category) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${categoryColors[category] || '#6b7280'}; width: 25px; height: 25px; border-radius: 50% 50% 50% 0; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transform: rotate(-45deg);"></div>`,
                iconSize: [25, 25],
                iconAnchor: [12, 24],
                popupAnchor: [0, -24]
            });
        }
document.addEventListener('DOMContentLoaded', () => {
      initializeUI();
      initializeMap();
      initializeSocket();
      fetchPlaces();
    });
    function initializeUI() {
      const categoryButtons = document.getElementById('categoryButtons');
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = `category-btn ${cat === 'all' ? 'active' : ''}`;
        btn.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
        btn.onclick = () => selectCategory(cat);
        categoryButtons.appendChild(btn);
      });
      const categorySelect = document.getElementById('placeCategory');
            categories.filter(c => c !== 'all').forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });

            document.getElementById('toggleFormBtn').onclick = toggleForm;
            document.getElementById('addPlaceForm').onsubmit = addPlace;
        }
      
      function initializeMap() {
            map = L.map('map').setView(PUNE_CENTER, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            map.on('click', onMapClick);
        }

        function onMapClick(e) {
      console.log('Map clicked! isAddingPlace:', isAddingPlace);
    
    if (!isAddingPlace) {
        console.log('Not in add mode - click "+ Add Place" first');
        return;
    }

    const { lat, lng } = e.latlng;
    console.log('Location:', lat, lng);
    
    if (tempMarker) {
        map.removeLayer(tempMarker);
    }
     tempMarker = L.marker([lat, lng], {
        icon: L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41]
        })
    }).addTo(map);
    
    document.getElementById('placeLat').value = lat.toFixed(6);
    document.getElementById('placeLng').value = lng.toFixed(6);
    console.log('Marker placed! Lat/Lng fields updated');
}
    function initializeSocket() {
      socket = io(API_URL);

      socket.on('place-added', (place) => {
        places.push(place);
        updateUI();
      });

      socket.on('place-updated', (place) => {
        const index = places.findIndex(p => p._id === place._id);
        if (index !== -1) {
          places[index] = place;
          updateUI();
        }
      });

      socket.on('place-deleted', (placeId) => {
        places = places.filter(p => p._id !== placeId);
        updateUI();
      });

      socket.on('place-visited', (place) => {
        const index = places.findIndex(p => p._id === place._id);
        if (index !== -1) {
          places[index] = place;
          updateUI();
        }
      });
    }

    async function fetchPlaces() {
      try {
        const res = await fetch(`${API_URL}/api/places`);
        places = await res.json();
        updateUI();
      } catch (err) {
        console.error('Error fetching places:', err);
      }
    }

    function selectCategory(cat) {
      selectedCategory = cat;
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase() === cat) {
          btn.classList.add('active');
        }
      });

      updateUI();
    }

   function toggleForm() {
  const form = document.getElementById('addPlaceForm');
  const btn = document.getElementById('toggleFormBtn');
  const instruction = document.getElementById('mapInstruction');
  
  form.classList.toggle('hidden');
  instruction.classList.toggle('hidden');
  isAddingPlace = !form.classList.contains('hidden');
  
  btn.textContent = isAddingPlace ? 'Cancel' : '+ Add Place';
  btn.classList.toggle('cancel', isAddingPlace);
  if (!isAddingPlace && tempMarker) { 
    map.removeLayer(tempMarker);
    tempMarker = null;
    document.getElementById('addPlaceForm').reset();
    document.getElementById('placeRating').value = '5';
  }
  
  console.log('Add mode:', isAddingPlace ? 'ENABLED' : 'DISABLED');
}

    async function addPlace(e) {
      e.preventDefault();
      
      const lat = tempMarker 
        ? tempMarker.getLatLng().lat 
        : parseFloat(document.getElementById('placeLat').value);
    const lng = tempMarker 
        ? tempMarker.getLatLng().lng 
        : parseFloat(document.getElementById('placeLng').value);

    const formData = {
        name: document.getElementById('placeName').value,
        category: document.getElementById('placeCategory').value,
        lat: lat, 
        lng: lng, 
        description: document.getElementById('placeDescription').value,
        rating: parseInt(document.getElementById('placeRating').value)
    };

    if (!formData.name || !formData.category || isNaN(formData.lat) || isNaN(formData.lng)) {
        alert('Please ensure Name, Category, Latitude, and Longitude are filled.');
        return;
    }

    try {
        const response = await fetch(`${API_URL}/api/places`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to add place');
        }

        document.getElementById('addPlaceForm').reset();
        if (tempMarker) {
            map.removeLayer(tempMarker);
            tempMarker = null;
        }
        toggleForm(); 

    } catch (err) {
        console.error('Error adding place:', err.message);
        alert(`Error adding place: ${err.message}. Check console for details.`);
    }
}

    async function deletePlace(id) {
      if (!confirm('Delete this place?')) return;
      
      try {
        await fetch(`${API_URL}/api/places/${id}`, { method: 'DELETE' });
      } catch (err) {
        console.error('Error deleting place:', err);
      }
    }

    async function markVisit(id) {
      try {
        await fetch(`${API_URL}/api/places/${id}/visit`, { method: 'POST' });
      } catch (err) {
        console.error('Error marking visit:', err);
      }
    }

    function updateUI() {
      filteredPlaces = selectedCategory === 'all' 
        ? places 
        : places.filter(p => p.category === selectedCategory);
      renderPlacesList();
      if (map) {
        updateMarkers();
      }
    }

    function renderPlacesList() {
      const placesList = document.getElementById('placesList');
      const placeCount = document.getElementById('placeCount');
      
      placeCount.textContent = filteredPlaces.length;
      placesList.innerHTML = '';

      filteredPlaces.forEach(place => {
        const card = document.createElement('div');
        card.className = 'place-card';
        card.innerHTML = `
          <h4>${place.name}</h4>
          <p class="category">${place.category}</p>
          <p class="description">${place.description}</p>
          <p class="rating">â­ ${place.rating}</p>
          <p class="visits">Visits: ${place.visitCount}</p>
          <div class="place-actions">
            <button class="visit-btn" onclick="markVisit('${place._id}')">Mark Visit</button>
            <button class="delete-btn" onclick="deletePlace('${place._id}')">Delete</button>
          </div>
        `;
        placesList.appendChild(card);
      });
    }

    function updateMarkers() {
    // 1. Clear existing Leaflet markers
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];

    filteredPlaces.forEach(place => {
        const customIcon = createCustomIcon(place.category);
        
        // 2. Create the Leaflet marker and add it to the map
        const marker = L.marker([place.lat, place.lng], {
            icon: customIcon,
            title: place.name
        }).addTo(map);

        // 3. Define the popup content
        const popupContent = `
            <div class="info-window">
                <h3>${place.name}</h3>
                <p><strong>Category:</strong> ${place.category}</p>
                <p><strong>Description:</strong> ${place.description}</p>
                <p><strong>Rating:</strong> â­ ${place.rating}</p>
                <p><strong>Visits:</strong> ${place.visitCount}</p>
                <div class="place-actions">
                    <button onclick="markVisit('${place._id}')">Mark Visit</button>
                </div>
            </div>
        `;
        
        // 4. Bind the popup content
        marker.bindPopup(popupContent); 

        // 5. CRITICAL FIX: Add explicit click listener to ensure popup opens
        marker.on('click', function() {
            this.openPopup();
        });
        
        markers.push(marker);
    });
}
    window.deletePlace = deletePlace;
    window.markVisit = markVisit;
  </script>
</body>
</html>